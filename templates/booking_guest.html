<!DOCTYPE html>
<html>
<head>
    <title>å¿«é€Ÿè¨‚ç¥¨ (è¨ªå®¢)</title>
    <style>
        body { background-color: #222; color: #ddd; font-family: sans-serif; display: flex; justify-content: center; height: 100vh; padding-top: 50px; }
        .container { background: #333; padding: 40px; border-radius: 10px; width: 500px; }
        .secure-badge { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 14px; font-weight: bold;}
        
        /* åº§ä½åœ–æ¨£å¼ (Toggle OFF) */
        .seat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px 0; }
        .seat { background: #555; padding: 10px; text-align: center; border-radius: 4px; cursor: pointer; }
        .seat.taken { background: #b71c1c; cursor: not-allowed; opacity: 0.5; }
        .seat.selected { background: #4CAF50; color: white; }

        /* åå¥½é¸é …æ¨£å¼ (Toggle ON) */
        .pref-option { display: block; background: #444; margin: 10px 0; padding: 15px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .pref-option:hover { background: #555; }
        .pref-option.active { border-color: #4CAF50; background: #383838; }
        .pref-icon { font-size: 1.2em; margin-right: 10px; }

        .hidden { display: none; }
        .btn { width: 100%; padding: 15px; background: #e50914; color: white; border: none; font-size: 18px; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="secure-badge">ğŸ”’ å®‰å…¨åŠ å¯†é€£ç·š | å…ç™»å…¥æ¨¡å¼</div>
        <h2>ğŸ« é¸æ“‡æ‚¨çš„ä½ç½®</h2>

        <label>è¯çµ¡ Email</label>
        <input type="email" id="email" style="width:95%; padding:10px; margin-bottom:20px;" placeholder="ticket@example.com">
        <label>äººæ•¸</label>
        <input type="number" id="count" value="1" min="1" max="4" style="width:50px; padding:5px;">

        <hr style="border-color:#444; margin: 20px 0;">

        <div id="auto-section" class="hidden">
            <h3>æ‚¨å–œæ­¡ä»€éº¼æ¨£çš„ä½å­ï¼Ÿ</h3>
            <p style="color:#aaa; font-size:0.9em;">ç³»çµ±å°‡ç‚ºæ‚¨è‡ªå‹•é–å®šæœ€ä½³ç©ºä½</p>
            <div id="pref-list"></div>
        </div>

        <div id="manual-section" class="hidden">
            <h3>è«‹é»é¸åº§ä½</h3>
            <div style="background: white; height: 5px; margin-bottom: 10px; border-radius: 2px;"></div>
            <p style="text-align: center; font-size: 0.8em; color: #888;">è¢å¹•æ–¹å‘</p>
            <div id="seat-map" class="seat-grid"></div>
        </div>

        <button id="submitBtn" class="btn">ç¢ºèªè¨‚ç¥¨</button>
    </div>

    <script>
        // è¨­å®š API ç¶²å€ (æœ¬åœ°æˆ– ngrok)
        const API_BASE = ''; 
        let currentMode = '';
        let selectedSeats = [];
        let selectedPref = '';

        // 1. é é¢è¼‰å…¥æ™‚ï¼Œå…ˆå•å¾Œç«¯ Toggle ç‹€æ…‹
        async function init() {
            const res = await fetch(`${API_BASE}/api/seat-config`, { credentials: 'include' });
            const config = await res.json();
            currentMode = config.mode;

            if (currentMode === 'auto') {
                // --- é¡¯ç¤ºåå¥½é¸é … ---
                document.getElementById('auto-section').classList.remove('hidden');
                const list = document.getElementById('pref-list');
                config.preferences.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'pref-option';
                    div.innerHTML = `<span class="pref-icon">${p.label.split(' ')[0]}</span> ${p.label.split(' ')[1]}`;
                    div.onclick = () => {
                        // æ¸…é™¤å…¶ä»–é¸æ“‡æ¨£å¼
                        document.querySelectorAll('.pref-option').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                        selectedPref = p.key;
                    };
                    list.appendChild(div);
                });
                // é è¨­é¸ç¬¬ä¸€å€‹
                if(list.firstChild) list.firstChild.click();

            } else {
                // --- é¡¯ç¤ºåº§ä½åœ°åœ– ---
                document.getElementById('manual-section').classList.remove('hidden');
                const map = document.getElementById('seat-map');
                config.seats.forEach(s => {
                    const div = document.createElement('div');
                    div.className = `seat ${s.status === 1 ? 'taken' : ''}`;
                    div.innerText = s.id;
                    if (s.status === 0) {
                        div.onclick = () => toggleSeat(s.id, div);
                    }
                    map.appendChild(div);
                });
            }
        }

        function toggleSeat(id, el) {
            if (selectedSeats.includes(id)) {
                selectedSeats = selectedSeats.filter(s => s !== id);
                el.classList.remove('selected');
            } else {
                // é™åˆ¶é¸æ“‡æ•¸é‡ (ç°¡æ˜“ç‰ˆ)
                const max = document.getElementById('count').value;
                if(selectedSeats.length >= max) { alert(`æœ€å¤šé¸æ“‡ ${max} å€‹åº§ä½`); return; }
                
                selectedSeats.push(id);
                el.classList.add('selected');
            }
        }

        // 2. é€å‡ºè¨‚å–®
        document.getElementById('submitBtn').addEventListener('click', async () => {
            const payload = {
                email: document.getElementById('email').value,
                count: document.getElementById('count').value,
                // æ ¹æ“šæ¨¡å¼å‚³é€ä¸åŒè³‡æ–™
                preference: currentMode === 'auto' ? selectedPref : null,
                selected_seats: currentMode === 'manual' ? selectedSeats : null
            };

            const res = await fetch(`${API_BASE}/api/book`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (data.success) {
                let msg = currentMode === 'auto' 
                    ? `ç³»çµ±å·²ç‚ºæ‚¨å®‰æ’åº§ä½ï¼š${data.seats.join(', ')}`
                    : `æ‚¨é¸æ“‡çš„åº§ä½ï¼š${data.seats.join(', ')}`;
                alert('è¨‚ç¥¨æˆåŠŸï¼\n' + msg);
                window.location.href = 'success.html?order=' + data.order_id;
            } else {
                alert('å¤±æ•—ï¼š' + data.error);
            }
        });

        init();
    </script>
</body>
</html>