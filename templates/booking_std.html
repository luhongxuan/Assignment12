<!DOCTYPE html>
<html>
<head>
    <title>æœƒå“¡è¨‚ç¥¨å°ˆå€</title>
    <style>
        body { background-color: #1a1a1a; color: #ddd; font-family: sans-serif; display: flex; justify-content: center; padding-top: 50px; }
        .container { background: #2c2c2c; padding: 40px; border-radius: 10px; width: 500px; border: 1px solid #444; }
        
        /* æœƒå“¡å°ˆå±¬æ¨£å¼ */
        .member-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #555; padding-bottom: 15px; margin-bottom: 20px; }
        .avatar { width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .points { color: #fbbf24; font-size: 0.9em; }

        /* å…±ç”¨çš„åº§ä½ UI (è·Ÿ Guest ä¸€æ¨£) */
        .seat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px 0; }
        .seat { background: #555; padding: 10px; text-align: center; border-radius: 4px; cursor: pointer; }
        .seat.taken { background: #b91c1c; cursor: not-allowed; opacity: 0.5; }
        .seat.selected { background: #3b82f6; color: white; } /* æœƒå“¡ç”¨è—è‰² */
        
        .pref-option { display: block; background: #444; margin: 10px 0; padding: 15px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
        .pref-option:hover { background: #555; }
        .pref-option.active { border-color: #3b82f6; background: #383838; }

        .hidden { display: none; }
        .btn { width: 100%; padding: 15px; background: #3b82f6; color: white; border: none; font-size: 18px; margin-top: 20px; cursor: pointer; transition: 0.3s; }
        .btn:hover { background: #2563eb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="member-header">
            <div>
                <h2 style="margin:0">å°Šæ¦®æœƒå“¡è¨‚ç¥¨</h2>
                <span class="points">âœ¨ ç¾æœ‰ç´…åˆ©é»æ•¸: 1,250 é»</span>
            </div>
            <div class="avatar">M</div>
        </div>

        <form onsubmit="return false;">
            <label>é¸æ“‡é›»å½±</label>
            <select id="movie" style="width:100%; padding:10px; margin: 10px 0; background:#444; color:white; border:none;">
                <option value="devops-war">DevOps ä¸–ç•Œå¤§æˆ° (IMAX)</option>
            </select>

            <div style="margin: 15px 0;">
                <label><input type="checkbox" id="usePoints"> ä½¿ç”¨ 50 é»æŠ˜æŠµç¾é‡‘</label>
            </div>

            <label>äººæ•¸: <span id="countDisplay">1</span></label>
            <input type="range" id="count" min="1" max="5" value="1" style="width:100%" oninput="document.getElementById('countDisplay').innerText=this.value">

            <hr style="border-color:#444; margin: 20px 0;">

            <div id="auto-section" class="hidden">
                <h3>ğŸ¤– æ™ºæ…§é…ä½ (æœƒå“¡å„ªå…ˆä¿ç•™å¸­)</h3>
                <div id="pref-list"></div>
            </div>

            <div id="manual-section" class="hidden">
                <h3>ğŸ—ºï¸ è«‹é¸æ“‡åº§ä½</h3>
                <div id="seat-map" class="seat-grid"></div>
            </div>

            <button id="submitBtn" class="btn">ç¢ºèªè¨‚ç¥¨</button>
        </form>
    </div>

    <script>
        // è¨­å®š API ç¶²å€ (æœ¬åœ°æˆ– ngrok)
        const API_BASE = '';  
        let currentMode = '';
        let selectedSeats = [];
        let selectedPref = '';

        async function init() {
            // å‘¼å«åŒä¸€æ”¯å¾Œç«¯ API å–å¾—ç›®å‰çš„ Toggle ç‹€æ…‹
            // é€™é«”ç¾äº† "Single Source of Truth" (å–®ä¸€çœŸç†ä¾†æº)
            const res = await fetch(`${API_BASE}/api/seat-config`, { credentials: 'include' });
            const config = await res.json();
            currentMode = config.mode;

            if (currentMode === 'auto') {
                document.getElementById('auto-section').classList.remove('hidden');
                const list = document.getElementById('pref-list');
                config.preferences.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'pref-option';
                    div.innerHTML = `${p.label}`; // æœƒå“¡é é¢ç°¡å–®ä¸€é»ï¼Œä¸ä¸€å®šè¦ Icon
                    div.onclick = () => {
                        document.querySelectorAll('.pref-option').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                        selectedPref = p.key;
                    };
                    list.appendChild(div);
                });
                if(list.firstChild) list.firstChild.click();

            } else {
                document.getElementById('manual-section').classList.remove('hidden');
                const map = document.getElementById('seat-map');
                config.seats.forEach(s => {
                    const div = document.createElement('div');
                    div.className = `seat ${s.status === 1 ? 'taken' : ''}`;
                    div.innerText = s.id;
                    if (s.status === 0) {
                        div.onclick = () => toggleSeat(s.id, div);
                    }
                    map.appendChild(div);
                });
            }
        }

        function toggleSeat(id, el) {
            const max = document.getElementById('count').value;
            if (selectedSeats.includes(id)) {
                selectedSeats = selectedSeats.filter(s => s !== id);
                el.classList.remove('selected');
            } else {
                // æœƒå“¡å¦‚æœæƒ³é‡é¸ï¼Œå°±å¿…é ˆå…ˆå–æ¶ˆå…¶ä»–çš„ (é€™è£¡é‚è¼¯ç¨å¾®åš´æ ¼ä¸€é»)
                if(selectedSeats.length >= max) {
                    // è‡ªå‹•ç§»é™¤æœ€æ—©é¸çš„ä¸€å€‹ (æå‡ UX)
                    const first = selectedSeats.shift(); 
                    const firstEl = Array.from(document.querySelectorAll('.seat')).find(e => e.innerText === first);
                    if(firstEl) firstEl.classList.remove('selected');
                }
                selectedSeats.push(id);
                el.classList.add('selected');
            }
        }

        document.getElementById('submitBtn').addEventListener('click', async () => {
            const payload = {
                // æœƒå“¡ä¸ç”¨å‚³ Emailï¼Œå› ç‚ºå¾Œç«¯ Session å·²ç¶“çŸ¥é“ä»–æ˜¯èª°
                movie: document.getElementById('movie').value,
                count: document.getElementById('count').value,
                preference: currentMode === 'auto' ? selectedPref : null,
                selected_seats: currentMode === 'manual' ? selectedSeats : null
            };

            const res = await fetch(`${API_BASE}/api/book`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (data.success) {
                alert(`è¨‚ç¥¨æˆåŠŸï¼(æœƒå“¡è¨‚å–®)\nåº§ä½: ${data.seats.join(', ')}`);
                window.location.href = 'success.html?order=' + data.order_id;
            } else {
                alert('å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
        });

        init();
    </script>
</body>
</html>